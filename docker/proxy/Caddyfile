# Centralized Caddyfile for TLS termination and Routing
# 
# Requires an external network `caddy` to route to services by their container name.

{$ACME_EMAIL:?required}

# -------------------------
# Protected Container Route
# -------------------------
protected.{$PUBLIC_DOMAIN} {
    tls {$ACME_EMAIL}
    header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    basicauth /* {
        {$BASIC_AUTH_USER} {$BASIC_AUTH_HASH}
    }

    reverse_proxy protected-container:8080 {
        header_up Upgrade {http.request.header.Upgrade}
        header_up Connection {http.request.header.Connection}
    }
}

# -------------------------
# Portainer Admin Route
# -------------------------
portainer.{$PUBLIC_DOMAIN} {
    tls {$ACME_EMAIL}
    header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # Route to the admin portal of portainer over the secure local HTTP network
    reverse_proxy portainer:9000
}

# -------------------------
# Default Healthcheck Block
# -------------------------
:80 {
    respond /healthz "OK" 200
}
